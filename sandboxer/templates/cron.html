<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{cron_name}} - Sandboxer</title>
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body { display: flex; flex-direction: column; height: 100vh; margin: 0; background: var(--base); }
    .cron-header { display: flex; align-items: center; gap: 1ch; padding: 0.5em 1ch; background: var(--mantle); border-bottom: 1px solid var(--surface0); }
    .cron-header h1 { font-size: 1em; margin: 0; color: var(--text); font-weight: normal; }
    .cron-header .cron-id { color: var(--overlay0); font-size: 0.85em; }
    .cron-header .actions { margin-left: auto; display: flex; gap: 0.5ch; }
    .cron-container { display: flex; flex: 1; overflow: hidden; }
    .cron-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .cron-panel + .cron-panel { border-left: 1px solid var(--surface0); }
    .panel-header { padding: 0.4em 1ch; background: var(--surface0); color: var(--subtext0); font-size: 0.85em; display: flex; align-items: center; gap: 1ch; }
    .panel-header .refresh-btn { margin-left: auto; background: transparent; border: none; color: var(--overlay0); cursor: pointer; padding: 0.2em 0.5em; }
    .panel-header .refresh-btn:hover { color: var(--text); }
    .panel-content { flex: 1; overflow: auto; padding: 1ch; font-family: monospace; font-size: 0.9em; white-space: pre-wrap; word-break: break-word; background: var(--crust); color: var(--text); }
    .panel-content.config { background: var(--base); }
    .log-line { line-height: 1.5; }
    .log-line .timestamp { color: var(--overlay0); }
    .log-line .skip { color: var(--yellow); }
    .log-line .error { color: var(--red); }
    .log-line .success { color: var(--green); }
    @media (max-width: 800px) {
      .cron-container { flex-direction: column; }
      .cron-panel + .cron-panel { border-left: none; border-top: 1px solid var(--surface0); }
    }
  </style>
</head>
<body>
  <header class="cron-header">
    <h1>{{cron_name}}</h1>
    <span class="cron-id">{{cron_id}}</span>
    <div class="actions">
      <button class="btn-green" onclick="triggerCron()">Run Now</button>
      <button class="btn-mauve" onclick="editConfig()">Edit</button>
      <button class="btn-surface1" onclick="window.close()">Close</button>
    </div>
  </header>
  <div class="cron-container">
    <div class="cron-panel">
      <div class="panel-header">
        <span>Log</span>
        <button class="refresh-btn" onclick="refreshLog()">↻ refresh</button>
      </div>
      <div class="panel-content log" id="logContent">Loading...</div>
    </div>
    <div class="cron-panel">
      <div class="panel-header">
        <span>Config</span>
        <button class="refresh-btn" onclick="refreshConfig()">↻ refresh</button>
      </div>
      <div class="panel-content config" id="configContent">Loading...</div>
    </div>
  </div>

  <script>
    const cronId = "{{cron_id}}";
    const repoPath = "{{repo_path}}";

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatLog(text) {
      return text.split('\n').map(line => {
        if (!line.trim()) return '';

        // Parse timestamp and message
        const match = line.match(/^\[([^\]]+)\]\s*(.*)$/);
        if (match) {
          const timestamp = match[1];
          const message = match[2];

          let msgClass = '';
          if (message.toLowerCase().includes('skip')) msgClass = 'skip';
          else if (message.toLowerCase().includes('error')) msgClass = 'error';
          else if (message.toLowerCase().includes('success') || message.toLowerCase().includes('executed')) msgClass = 'success';

          return `<div class="log-line"><span class="timestamp">[${escapeHtml(timestamp)}]</span> <span class="${msgClass}">${escapeHtml(message)}</span></div>`;
        }
        return `<div class="log-line">${escapeHtml(line)}</div>`;
      }).join('');
    }

    async function refreshLog() {
      try {
        const res = await fetch(`/api/crons/${encodeURIComponent(cronId)}/log`);
        const data = await res.json();
        const logEl = document.getElementById('logContent');
        logEl.innerHTML = formatLog(data.log || '(empty)');
        logEl.scrollTop = logEl.scrollHeight;
      } catch (err) {
        document.getElementById('logContent').textContent = 'Error loading log: ' + err.message;
      }
    }

    async function refreshConfig() {
      try {
        const res = await fetch(`/api/crons/${encodeURIComponent(cronId)}/config`);
        const data = await res.json();
        document.getElementById('configContent').textContent = data.config || '(empty)';
      } catch (err) {
        document.getElementById('configContent').textContent = 'Error loading config: ' + err.message;
      }
    }

    async function triggerCron() {
      try {
        const res = await fetch(`/api/crons/${encodeURIComponent(cronId)}/trigger`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          alert('Cron triggered! Check the main dashboard for the new session.');
          setTimeout(refreshLog, 2000);
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error triggering cron: ' + err.message);
      }
    }

    function editConfig() {
      // Open config in a new bash session with nano
      window.location.href = `/api/crons/${encodeURIComponent(cronId)}/edit`;
    }

    // Initial load
    refreshLog();
    refreshConfig();

    // Auto-refresh log every 10 seconds
    setInterval(refreshLog, 10000);
  </script>
</body>
</html>
