#!/bin/bash
# sandboxer-shell - Interactive session picker for SSH takeover
# Install: sudo ln -sf /home/sandboxer/sandboxer-repo/sandboxer-shell /usr/local/bin/sandboxer-shell
# Usage:
#   ssh -t sandboxer@host sandboxer-shell           # interactive picker
#   ssh -t sandboxer@host sandboxer-shell SESSION   # attach directly
#
# Multi-select: Use TAB/Shift-TAB to select multiple sessions, creates split panes

set -e

# Use sudo for tmux since sessions run as root
TMUX_CMD="sudo tmux"

# Direct attach mode if session name provided
if [ -n "$1" ]; then
    session="$1"
    if $TMUX_CMD has-session -t "$session" 2>/dev/null; then
        exec $TMUX_CMD attach -t "$session"
    else
        echo "Session '$session' not found"
        exec bash
    fi
fi

# Colors (Catppuccin Mocha)
MAUVE=$'\033[38;2;203;166;247m'
RESET=$'\033[0m'

get_sessions() {
    $TMUX_CMD list-sessions -F "#{session_name}" 2>/dev/null || true
}

format_session() {
    local name="$1"
    local created=$($TMUX_CMD display-message -t "$name" -p "#{session_created}" 2>/dev/null || echo "0")
    local attached=$($TMUX_CMD display-message -t "$name" -p "#{session_attached}" 2>/dev/null || echo "0")
    local title=$($TMUX_CMD display-message -t "$name" -p "#{pane_title}" 2>/dev/null || echo "")

    # Time ago
    local now=$(date +%s)
    local diff=$((now - created))
    local time_ago
    if [ $diff -lt 60 ]; then
        time_ago="now"
    elif [ $diff -lt 3600 ]; then
        time_ago="$((diff / 60))m"
    elif [ $diff -lt 86400 ]; then
        time_ago="$((diff / 3600))h"
    else
        time_ago="$((diff / 86400))d"
    fi

    # Status indicator
    local status="  "
    [ "$attached" = "1" ] && status="● "

    # Clean title
    [[ "$title" == *"✳"* ]] && title="${title#*✳ }"

    if [ -n "$title" ] && [ "$title" != "Window Title" ] && [ "$title" != "$name" ]; then
        echo "$status$title ($name) [$time_ago]"
    else
        echo "$status$name [$time_ago]"
    fi
}

create_split_session() {
    local sessions=("$@")
    local count=${#sessions[@]}
    local split_name="split-$(date +%s)"

    # Create new session with first selection
    unset TMUX
    $TMUX_CMD new-session -d -s "$split_name"
    $TMUX_CMD send-keys -t "$split_name" "unset TMUX && sudo tmux attach -t '${sessions[0]}'" Enter

    # Add panes for remaining sessions
    for ((i=1; i<count; i++)); do
        $TMUX_CMD split-window -t "$split_name"
        $TMUX_CMD send-keys -t "$split_name" "unset TMUX && sudo tmux attach -t '${sessions[$i]}'" Enter
        $TMUX_CMD select-layout -t "$split_name" tiled
    done

    $TMUX_CMD set -t "$split_name" mouse on
    exec $TMUX_CMD attach -t "$split_name"
}

main() {
    local sessions_raw=$(get_sessions)

    if [ -z "$sessions_raw" ]; then
        echo -e "${MAUVE}No active sessions${RESET}"
        exec bash -l
    fi

    # Build fzf input
    local fzf_input=""
    while read -r name; do
        [ -z "$name" ] && continue
        fzf_input+="$(format_session "$name")|$name"$'\n'
    done <<< "$sessions_raw"

    # Run fzf with multi-select
    local selected
    selected=$(echo -e "$fzf_input" | fzf \
        --multi \
        --delimiter='|' \
        --with-nth=1 \
        --height=50% \
        --reverse \
        --border=rounded \
        --border-label=" sandboxer " \
        --border-label-pos=3 \
        --prompt="› " \
        --pointer="▶" \
        --marker="✓" \
        --header="TAB: multi-select │ ENTER: attach" \
        --color="fg:#cdd6f4,bg:#1e1e2e,hl:#f38ba8" \
        --color="fg+:#cdd6f4,bg+:#313244,hl+:#f38ba8" \
        --color="info:#94e2d5,prompt:#cba6f7,pointer:#f5e0dc" \
        --color="marker:#a6e3a1,spinner:#f5e0dc,header:#6c7086" \
        --color="border:#6c7086,label:#cba6f7" \
        --bind="ctrl-c:abort" \
        2>/dev/null) || exit 0

    # Extract session names
    local session_names=()
    while read -r line; do
        [ -z "$line" ] && continue
        session_names+=("${line##*|}")
    done <<< "$selected"

    if [ ${#session_names[@]} -eq 0 ]; then
        exit 0
    elif [ ${#session_names[@]} -eq 1 ]; then
        # Single session - direct attach
        exec $TMUX_CMD attach -t "${session_names[0]}"
    else
        # Multiple sessions - create split view
        create_split_session "${session_names[@]}"
    fi
}

main "$@"
