#!/bin/bash
# Helper functions for sandboxer-shell (sourced by fzf reload)

TMUX_CMD="sudo tmux"
WORKDIRS_FILE="/etc/sandboxer/session_workdirs.json"

get_workdir() {
    local name="$1"
    if [ -f "$WORKDIRS_FILE" ]; then
        python3 -c "import json; d=json.load(open('$WORKDIRS_FILE')); print(d.get('$name', ''))" 2>/dev/null || echo ""
    fi
}

format_session() {
    local name="$1"
    local created=$($TMUX_CMD display-message -t "$name" -p "#{session_created}" 2>/dev/null || echo "0")
    local attached=$($TMUX_CMD display-message -t "$name" -p "#{session_attached}" 2>/dev/null || echo "0")
    local title=$($TMUX_CMD display-message -t "$name" -p "#{pane_title}" 2>/dev/null || echo "")
    local workdir=$(get_workdir "$name")

    local now=$(date +%s)
    local diff=$((now - created))
    local time_ago
    if [ $diff -lt 60 ]; then
        time_ago="now"
    elif [ $diff -lt 3600 ]; then
        time_ago="$((diff / 60))m"
    elif [ $diff -lt 86400 ]; then
        time_ago="$((diff / 3600))h"
    else
        time_ago="$((diff / 86400))d"
    fi

    local status="  "
    [ "$attached" = "1" ] && status="● "

    [[ "$title" == *"✳"* ]] && title="${title#*✳ }"

    local folder_short="?"
    if [ -n "$workdir" ]; then
        folder_short=$(basename "$workdir")
        [ "$folder_short" = "/" ] && folder_short="/"
    fi

    if [ -n "$title" ] && [ "$title" != "Window Title" ] && [ "$title" != "$name" ]; then
        echo "$status[$folder_short] $title ($name) [$time_ago]"
    else
        echo "$status[$folder_short] $name [$time_ago]"
    fi
}

build_session_list() {
    local folder_filter="$1"
    local hint="$2"

    # Print hint line first if provided
    [ -n "$hint" ] && echo "$hint"

    for name in $($TMUX_CMD list-sessions -F "#{session_name}" 2>/dev/null); do
        [[ "$name" == split-* ]] && continue

        if [ -n "$folder_filter" ]; then
            local workdir=$(get_workdir "$name")
            [ "$workdir" != "$folder_filter" ] && [[ "$workdir" != "$folder_filter/"* ]] && continue
        fi

        echo "$(format_session "$name")|$name"
    done
}

# If called directly, run build_session_list with env vars
if [ -n "${BASH_SOURCE[0]}" ] && [ "${BASH_SOURCE[0]}" = "$0" ]; then
    build_session_list "$SANDBOXER_FOLDER_FILTER" "$SANDBOXER_HINT"
fi
