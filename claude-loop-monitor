#!/bin/bash
# claude-loop-monitor - Status display for claude-loop

STATUS_FILE="$1"
WORKDIR="$2"

while true; do
  clear
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘        CLAUDE LOOP MONITOR            â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""

  if [ -f "$STATUS_FILE" ]; then
    source "$STATUS_FILE"

    now=$(date +%s)
    elapsed=$((now - start_time))
    since_activity=$((now - last_activity))
    elapsed_fmt=$(printf '%02d:%02d:%02d' $((elapsed/3600)) $((elapsed%3600/60)) $((elapsed%60)))
    activity_fmt=$(printf '%02d:%02d' $((since_activity/60)) $((since_activity%60)))

    echo "  Iteration:    $iteration"
    echo "  Status:       $status"
    echo "  Elapsed:      $elapsed_fmt"
    echo "  Last change:  ${activity_fmt} ago"
    echo ""
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  Dir: $(basename "$WORKDIR")"
    echo ""

    if [ -f "$WORKDIR/PROMPT.md" ]; then
      echo "  ğŸ“‹ PROMPT.md (working)"
    elif [ -f "$WORKDIR/PROMPT.done.md" ]; then
      echo "  âœ… PROMPT.done.md (complete!)"
    elif [ -f "$WORKDIR/PROMPT.blocked.md" ]; then
      echo "  âŒ PROMPT.blocked.md (blocked)"
    else
      echo "  âš ï¸  No PROMPT file"
    fi

    echo ""
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  Recent files:"
    ls -t "$WORKDIR" 2>/dev/null | head -4 | while read f; do echo "    $f"; done

    echo ""
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    # Show restart conditions
    idle_min=$((since_activity / 60))
    remaining=$((60 - idle_min))
    if [ "$status" = "complete" ]; then
      echo "  âœ“ Task complete"
    elif [ "$status" = "restarting" ]; then
      echo "  â†» Restarting now..."
    elif [ "$status" = "claude_running" ]; then
      echo "  â— Claude running"
      if [ $remaining -le 10 ]; then
        echo "  âš  Idle restart in ${remaining}min"
      fi
    else
      echo "  Status: $status"
    fi
    echo ""
    echo "  Ctrl+B d = detach (keeps running)"
  else
    echo "  Waiting for loop..."
  fi

  sleep 2
done
